<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hello world</title>
    <style>*,
html,
body {
    border: 0;
    padding: 0;
    margin: 0;
    box-sizing: border-box;
    font-size: 16px;
    line-height: 1.25rem;
}

body {
    width: 100%;
    display: flex;
    flex-direction: column;
    background: #0e092d;
    height: 100vh;
    overflow: hidden;
}

header {
    width: 100%;
    height: 3rem;
    background-color: #0e092d;
    border-bottom: 1px solid #384687;
    display: flex;
    align-items: center;
    padding: 1rem;
}

header div.title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #c5fff1;
}

#app {
    width: 100%;
    flex-grow: 1;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow: hidden;
}

footer {
    height: 3rem;
    background-color: #0e092d;
    border-top: 1px solid #384687;
    display: flex;
    padding: 1rem;
    align-items: center;
    color: white;
}

.cli-window {
    width: 100%;
    max-width: 1200px;
    overflow-y: auto;
    height: 100%;
    border-radius: 0.67rem;
    background: linear-gradient(52deg, #140d3f 0%, #1d183e 100%);
    padding: 1rem;
    color: white;
}

.cli-window div {
    white-space: pre;
}

.intro {
    margin-bottom: 1rem;
}

div {
    font-size: 1em;
}

.prompt {
    display: flex;
}

.prompt .prefix {
    white-space: pre;
    color: #34e8bd;
}

.prompt input {
    flex-grow: 1;
    outline: none;
    border: none;
    background-color: transparent;
    color: white;
    font-size: 1em;
    caret-color: #34e8bd;
    caret-shape: block;
}

.output {
    margin-bottom: 0.5rem;
}

.comment,
.multiline-comment {
    color: gray;
    font-size: 1em;
}



.download-success {
    color: #34e8bd
}

.error {
    color: red;
}

.statement {
    color: pink;
    font-weight: 600;
}

.command {
    color: yellow;
}</style>
  </head>

  <body>
    <header>
      <div class="title">Spin Sqlite Explorer</div>
    </header>
    <div id="app"></div>
    <footer>This is the footer - do something with it</footer>
    <script>!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).redom={})}(this,(function(e){"use strict";function t(e,t){var i=function(e){for(var t=e.split(/([.#])/),i="",n="",o=1;o<t.length;o+=2)switch(t[o]){case".":i+=" "+t[o+1];break;case"#":n=t[o+1]}return{className:i.trim(),tag:t[0]||"div",id:n}}(e),n=i.tag,o=i.id,r=i.className,l=t?document.createElementNS(t,n):document.createElement(n);return o&&(l.id=o),r&&(t?l.setAttribute("class",r):l.className=r),l}function i(e,t){var i=w(e),o=w(t);return t===o&&o.__redom_view&&(t=o.__redom_view),o.parentNode&&(n(t,o,i),i.removeChild(o)),t}function n(e,t,i){var n=t.__redom_lifecycle;if(o(n))t.__redom_lifecycle={};else{var r=i;for(t.__redom_mounted&&u(t,"onunmount");r;){var l=r.__redom_lifecycle||{};for(var s in n)l[s]&&(l[s]-=n[s]);o(l)&&(r.__redom_lifecycle=null),r=r.parentNode}}}function o(e){if(null==e)return!0;for(var t in e)if(e[t])return!1;return!0}var r=["onmount","onremount","onunmount"],l="undefined"!=typeof window&&"ShadowRoot"in window;function s(e,t,i,o){var s=w(e),a=w(t);t===a&&a.__redom_view&&(t=a.__redom_view),t!==a&&(a.__redom_view=t);var f=a.__redom_mounted,d=a.parentNode;if(f&&d!==s&&n(0,a,d),null!=i)if(o){var h=w(i);h.__redom_mounted&&u(h,"onunmount"),s.replaceChild(a,h)}else s.insertBefore(a,w(i));else s.appendChild(a);return function(e,t,i,n){for(var o=t.__redom_lifecycle||(t.__redom_lifecycle={}),s=i===n,a=!1,f=0,d=r;f<d.length;f+=1){var h=d[f];s||e!==t&&h in e&&(o[h]=(o[h]||0)+1),o[h]&&(a=!0)}if(!a)return void(t.__redom_lifecycle={});var v=i,c=!1;(s||v&&v.__redom_mounted)&&(u(t,s?"onremount":"onmount"),c=!0);for(;v;){var _=v.parentNode,p=v.__redom_lifecycle||(v.__redom_lifecycle={});for(var m in o)p[m]=(p[m]||0)+o[m];if(c)break;(v.nodeType===Node.DOCUMENT_NODE||l&&v instanceof ShadowRoot||_&&_.__redom_mounted)&&(u(v,s?"onremount":"onmount"),c=!0),v=_}}(t,a,s,d),t}function u(e,t){"onmount"===t||"onremount"===t?e.__redom_mounted=!0:"onunmount"===t&&(e.__redom_mounted=!1);var i=e.__redom_lifecycle;if(i){var n=e.__redom_view,o=0;for(var r in n&&n[t]&&n[t](),i)r&&o++;if(o)for(var l=e.firstChild;l;){var s=l.nextSibling;u(l,t),l=s}}}function a(e,t,i){var n=w(e);if("object"==typeof t)for(var o in t)f(n,o,t[o]);else f(n,t,i)}function f(e,t,i){e.style[t]=null==i?"":i}var d="http://www.w3.org/1999/xlink";function h(e,t,i,n){var o=w(e);if("object"==typeof t)for(var r in t)h(o,r,t[r],n);else{var l=o instanceof SVGElement,s="function"==typeof i;if("style"===t&&"object"==typeof i)a(o,i);else if(l&&s)o[t]=i;else if("dataset"===t)c(o,i);else if(l||!(t in o)&&!s||"list"===t){if(l&&"xlink"===t)return void v(o,i);n&&"class"===t&&(i=o.className+" "+i),null==i?o.removeAttribute(t):o.setAttribute(t,i)}else o[t]=i}}function v(e,t,i){if("object"==typeof t)for(var n in t)v(e,n,t[n]);else null!=i?e.setAttributeNS(d,t,i):e.removeAttributeNS(d,t,i)}function c(e,t,i){if("object"==typeof t)for(var n in t)c(e,n,t[n]);else null!=i?e.dataset[t]=i:delete e.dataset[t]}function _(e){return document.createTextNode(null!=e?e:"")}function p(e,t,i){for(var n=0,o=t;n<o.length;n+=1){var r=o[n];if(0===r||r){var l=typeof r;"function"===l?r(e):"string"===l||"number"===l?e.appendChild(_(r)):y(w(r))?s(e,r):r.length?p(e,r,i):"object"===l&&h(e,r,null,i)}}}function m(e){return"string"==typeof e?g(e):w(e)}function w(e){return e.nodeType&&e||!e.el&&e||w(e.el)}function y(e){return e&&e.nodeType}function g(e){for(var i,n=[],o=arguments.length-1;o-- >0;)n[o]=arguments[o+1];var r=typeof e;if("string"===r)i=t(e);else{if("function"!==r)throw new Error("At least one argument required");var l=e;i=new(Function.prototype.bind.apply(l,[null].concat(n)))}return p(w(i),n,!0),i}var b=g,N=g;function x(e){for(var t=[],n=arguments.length-1;n-- >0;)t[n]=arguments[n+1];for(var o=w(e),r=k(e,t,o.firstChild);r;){var l=r.nextSibling;i(e,r),r=l}}function k(e,t,i){for(var n=i,o=Array(t.length),r=0;r<t.length;r++)o[r]=t[r]&&w(t[r]);for(var l=0;l<t.length;l++){var u=t[l];if(u){var a=o[l];if(a!==n)if(y(a)){var f=n&&n.nextSibling,d=null!=u.__redom_index&&f===o[l+1];s(e,u,n,d),d&&(n=f)}else null!=u.length&&(n=k(e,u,n));else n=n.nextSibling}}return n}g.extend=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return g.bind.apply(g,[this].concat(e))};var S=function(e,t,i){this.View=e,this.initData=i,this.oldLookup={},this.lookup={},this.oldViews=[],this.views=[],null!=t&&(this.key="function"==typeof t?t:function(e){return function(t){return t[e]}}(t))};function A(e,t,i,n){return new D(e,t,i,n)}S.prototype.update=function(e,t){for(var i=this,n=i.View,o=i.key,r=i.initData,l=null!=o,s=this.lookup,u={},a=Array(e.length),f=this.views,d=0;d<e.length;d++){var h=e[d],v=void 0;if(l){var c=o(h);v=s[c]||new n(r,h,d,e),u[c]=v,v.__redom_id=c}else v=f[d]||new n(r,h,d,e);v.update&&v.update(h,d,e,t),w(v.el).__redom_view=v,a[d]=v}this.oldViews=f,this.views=a,this.oldLookup=s,this.lookup=u};var D=function(e,t,i,n){this.View=t,this.initData=n,this.views=[],this.pool=new S(t,i,n),this.el=m(e),this.keySet=null!=i};D.prototype.update=function(e,t){void 0===e&&(e=[]);var n=this.keySet,o=this.views;this.pool.update(e,t);var r=this.pool,l=r.views,s=r.lookup;if(n)for(var u=0;u<o.length;u++){var a=o[u];null==s[a.__redom_id]&&(a.__redom_index=null,i(this,a))}for(var f=0;f<l.length;f++){l[f].__redom_index=f}x(this,l),n&&(this.lookup=s),this.views=l},D.extend=function(e,t,i,n){return D.bind(D,e,t,i,n)},A.extend=D.extend;var V=function(e,t){this.el=_(""),this.visible=!1,this.view=null,this._placeholder=this.el,e instanceof Node?this._el=e:e.el instanceof Node?(this._el=e,this.view=e):this._View=e,this._initData=t};V.prototype.update=function(e,t){var n=this._placeholder,o=this.el.parentNode;if(e){if(!this.visible)if(this._el)s(o,this._el,n),i(o,n),this.el=w(this._el),this.visible=e;else{var r=new(0,this._View)(this._initData);this.el=w(r),this.view=r,s(o,r,n),i(o,n)}this.view&&this.view.update&&this.view.update(t)}else if(this.visible){if(this._el)return s(o,n,this._el),i(o,this._el),this.el=n,void(this.visible=e);s(o,n,this.view),i(o,this.view),this.el=n,this.view=null}this.visible=e};var j=function(e,t,i){this.el=m(e),this.Views=t,this.initData=i};j.prototype.update=function(e,t){if(e!==this.route){var i=this.Views[e];this.route=e,i&&(i instanceof Node||i.el instanceof Node)?this.view=i:this.view=i&&new i(this.initData,t),x(this.el,[this.view])}this.view&&this.view.update&&this.view.update(t,e)};var C="http://www.w3.org/2000/svg";function E(e){for(var i,n=[],o=arguments.length-1;o-- >0;)n[o]=arguments[o+1];var r=typeof e;if("string"===r)i=t(e,C);else{if("function"!==r)throw new Error("At least one argument required");var l=e;i=new(Function.prototype.bind.apply(l,[null].concat(n)))}return p(w(i),n,!0),i}var T=E;E.extend=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return E.bind.apply(E,[this].concat(e))},E.ns=C,e.List=D,e.ListPool=S,e.Place=V,e.Router=j,e.el=b,e.h=N,e.html=g,e.list=A,e.listPool=function(e,t,i){return new S(e,t,i)},e.mount=s,e.place=function(e,t){return new V(e,t)},e.router=function(e,t,i){return new j(e,t,i)},e.s=T,e.setAttr=function(e,t,i){h(e,t,i)},e.setChildren=x,e.setData=c,e.setStyle=a,e.setXlink=v,e.svg=E,e.text=_,e.unmount=i,Object.defineProperty(e,"__esModule",{value:!0})}));</script>
    <script>const { el, mount, list, setAttr, setChildren } = redom
const encoder = new TextEncoder();
const decoder = new TextDecoder();

const model = {
    state: {
        loggedin: true,
        authkey: "6ec8930cf90c7f93688d476eb7f84db297bb9af9606ef2612291735b0a978348"
    }
}

const INTRO_TEXT = `Welcome to Spin SQL Explorer!

Type ".help" to list all available commands.
`

const HELP_TEXT = `The list of commands is 
.help to display help and list all commands
.tables to display all the tables
.dump to download a dump of the database
.schema to list the schema of the tables
`

const UNKNOWN_DOT_COMMAND = "Unknown usage of dot command. Type \".help\" to list all known commands"

class Prompt {
    constructor(prefix, callback, isPassword, handleArrowKeys) {
        this.handleArrowKeys = handleArrowKeys
        this.callback = callback
        this.input = el("input", {
            id: "hello",
            tabindex: 1,
            onkeydown: function (e) {
                if (e.keyCode === 13) {
                    e.preventDefault()
                    this.callback(this.input.value)
                }
                handleArrowKeys && handleArrowKeys(e)
            }.bind(this)
        })
        setAttr(this.input, { type: isPassword ? "password" : "text" })
        this.prefix = el("span.prefix", prefix)
        this.el = el("div.prompt", this.prefix, this.input)
    }
    update(prefix, isPassword) {
        this.input.value = ""
        this.prefix.textContent = prefix
        setAttr(this.input, { type: isPassword ? "password" : "text" })
        this.input.focus()
    }
    setFocus() {
        this.input.focus()
    }
    alterValue(value) {
        this.input.value = value
    }
}

class Li {
    constructor() {
        this.el = el("div.output");
    }
    update(data) {
        this.el.textContent = data.text
        if (data.type) {
            this.el.classList.add(data.type)
        }
    }
}

class LoginComponent {
    constructor(callback) {
        this.callback = callback
        this.username = ""
        this.password = ""
        this.isPassword = false
        this.state = 0
        this.history = list("div", Li)
        this.historyList = [{ text: `Enter credentials to login`, type: "" }]
        this.prompt = new Prompt("username:", this.handle_callback.bind(this))
        this.el = el("div", this.history, this.prompt)
        this.history.update(this.historyList)
        this.prompt.setFocus()
    }
    async handle_callback(value) {
        switch (this.state) {
            case 0:
                this.username = value
                this.historyList.push({ text: `username:${value}`, type: "" })
                this.state = 1
                this.prompt.update("password:", true)
                break;
            case 1:
                this.password = value
                this.prompt.textContent = "password:"
                this.historyList.push({ text: `password:********`, type: "" })
                if (await authenticate(this.username, this.password)) {
                    this.callback()
                } else {
                    this.historyList.push({ text: "Login credentials are wrong, retry" })
                    this.state = 0
                    this.prompt.update("username:", false)
                }
                break
        }
        this.history.update(this.historyList)
    }
    setFocus() {
        this.prompt.setFocus()
    }
}


class CommandComponent {
    constructor(callback, unauthorizedCallback, keycodeHandler) {
        this.callback = callback
        this.unauthorizedCallback = unauthorizedCallback
        this.keycodeHandler = keycodeHandler
        this.multilineStatus = {
            state: false,
            comment: false
        }
        this.commandHistory = []
        this.commandHistoryIndex = null
        this.multilineHistory = list("div", Li)
        this.multilineHistoryList = []
        this.inputSegment = ""
        this.prompt = new Prompt("> ", this.handle_callback.bind(this), false, this.handleKeyinputs.bind(this))
        this.el = el("div", this.multilineHistory, this.prompt)
        this.prompt.setFocus()
    }
    handleKeyinputs(e) {
        // Handle Arrow keys 
        if (e.keyCode === 38) {
            if (this.commandHistory.length == 0 || this.commandHistoryIndex == 0) {
                return
            }
            if (!this.commandHistoryIndex) {
                this.commandHistory.push(this.prompt.input.value)
                this.commandHistoryIndex = this.commandHistory.length - 2
                this.prompt.alterValue(this.commandHistory[this.commandHistoryIndex])
            } else {
                this.commandHistoryIndex -= 1
                this.prompt.alterValue(this.commandHistory[this.commandHistoryIndex])
            }
        } else if (e.keyCode === 40) {
            if (this.commandHistory.length == 0 || this.commandHistoryIndex == null) {
                return
            }
            this.commandHistoryIndex++
            if (this.commandHistoryIndex + 1 >= this.commandHistory.length) {
                this.prompt.alterValue(this.commandHistory.pop())
                this.commandHistoryIndex = null
            } else {
                this.prompt.alterValue(this.commandHistory[this.commandHistoryIndex])
            }
        }

        // Handle ctrl + c
        if (event.ctrlKey && event.key === 'c' || event.key === 'C') {
            this.cancelCommand()
        }

        this.keycodeHandler && this.keycodeHandler(e)

    }
    handle_callback(value) {
        value = value.trim()
        if (!value) {
            return
        }

        if (this.multilineStatus.state) {
            // Already in the middle of a multiline statement
            if (this.multilineStatus.comment) { this.handleMutlilineComment(value) }
            else {
                this.handleCommand(value)
            }
        } else {
            // handle single line comments
            if (this.isSingleComment(value)) {
                this.callback({ text: value, type: "comment" })
                this.resetInputSegment()
                this.prompt.update("> ")
                return
            }

            if (value.startsWith(".")) {
                this.handleDotcommand(value)
                return
            }
            // Check if begining of multiline comment
            if (this.isMultiCommentStart(value)) {
                this.handleMutlilineComment(value)
                return
            }
            // check if command is terminated with a semicolon
            this.handleCommand(value)
        }

    }
    isSingleComment(value) {
        return value.startsWith("--")
    }
    isMultiCommentStart(value) {
        return value.startsWith("/*")
    }
    handleMutlilineComment(value) {
        let prefix = ""
        if (!this.multilineStatus.state) {
            value.startsWith("--")
            this.multilineStatus.comment = true
            this.multilineStatus.state = true
            this.inputSegment = value
            prefix = ">"
        } else {
            this.inputSegment += `\n ${value}`
        }
        if (value.endsWith("*/")) {
            this.callback({ text: this.inputSegment, type: "multiline-comment" })
            this.resetInputSegment()
            return
        }
        this.multilineHistoryList.push({ text: `${prefix} ${value}` })
        this.multilineHistory.update(this.multilineHistoryList)
        this.prompt.update("")
    }
    async handleCommand(value) {
        let prefix = this.multilineStatus.state ? "" : ">"
        this.inputSegment += ` ${value}`
        if (value.endsWith(";")) {
            await this.runStatement(this.inputSegment)
            return
        } else {
            this.multilineStatus.state = true
        }
        this.multilineHistoryList.push({ text: `${prefix} ${value}` })
        this.multilineHistory.update(this.multilineHistoryList)
        this.prompt.update("")

    }
    handleDotcommand(value) {
        let args = value.split(" ")
        if (value == ".help") {
            this.callback({ text: `> ${value}`, type: "command" })
            this.callback({ text: HELP_TEXT })
        } else if (value == ".tables") {
            this.runStatement("SELECT name FROM sqlite_master WHERE type = 'table' AND name NOT LIKE 'sqlite%';", ".tables")
        } else if (args[0] == ".schema") {
            if (args.length > 2) {
                this.callback({ text: `> ${value}` })
                this.callback({ text: "ERROR: Takes at most 1 argument" })
                this.resetInputSegment()
                return
            }
            if (args[1]) {
                this.runStatement(`SELECT sql FROM sqlite_master WHERE name = '${args[1]}' AND name NOT LIKE 'sqlite%';;`, `.schema ${args[1]}`)
            } else {
                this.runStatement("SELECT sql FROM sqlite_master where name NOT LIKE 'sqlite%';", `.schema`)
            }
        } else if (args[0] == ".dump") {
            if (args.length > 1) {
                this.callback({ text: `> ${value}` })
                this.callback({ text: "ERROR: Currently takes no argumments", type: "error" })
                this.resetInputSegment()
                return
            }
            this.dump()
        } else {
            this.callback({ text: UNKNOWN_DOT_COMMAND })
        }
        this.resetInputSegment()
    }
    async runStatement(value, commandName) {
        if (this.commandHistoryIndex != null) {
            this.commandHistory.pop()
        }
        this.commandHistory.push(commandName || value)
        let res = await executeRequest(value)
        this.callback({ text: `> ${commandName || value} `, type: "statement" })
        if (res.status == "failed" && res.reason == "unauthorized") {
            this.unauthorizedCallback()
        }
        if (res.status == "success") {
            console.log(res.data)
            this.callback({ text: `${JSON.stringify(res.data.rows, null, 2)} `, type: "success" })
            console.log(jsonToHtmlTable(res.data.rows, res.data.columns))
        } else {
            this.callback({ text: `ERROR: ${res.reason} `, type: "error" })
        }
        this.resetInputSegment()
    }
    async dump() {
        let res = await dumpDB()
        if (res.status == "success") {
            this.callback({ text: `> .dump`, type: "statement" })
            this.callback({ text: `Dumped database to file named "dump.sql" successfully`, type: "download-success" })
            downloadTextFile(res.data, "dump.sql")
        } else {
            this.callback({ text: `ERROR: ${res.reason} `, type: "error" })
        }
        this.resetInputSegment()
    }
    setFocus() {
        this.prompt.setFocus()
    }
    cancelCommand() {
        this.inputSegment += this.prompt.input.value
        this.callback({ text: `> ${this.inputSegment} `, type: "cancelled" })
        this.callback({ text: `^C `, type: "cancelled" })
        this.resetInputSegment()
    }
    resetInputSegment() {
        this.multilineStatus.state = false
        this.multilineStatus.comment = false
        this.inputSegment = ""
        this.multilineHistoryList = []
        this.multilineHistory.update(this.multilineHistoryList)
        this.prompt.update("> ")
        this.commandHistoryIndex = null
    }
}

class App {
    constructor() {
        this.ismouseDown = false
        this.isMouseDrag = false
        this.loginComponent = new LoginComponent(this.authenticated.bind(this))
        this.commandComponent = new CommandComponent(this.addCommandOutputHistory.bind(this), this.setupAuth.bind(this), this.keyDownHandler.bind(this))
        this.history = list("div", Li)
        this.historyList = []
        this.intro = el("div.intro", INTRO_TEXT)
        if (model.state.loggedin) {
            this.el = el("div.cli-window", this.intro, this.history, this.commandComponent)
        } else {
            this.el = el("div.cli-window", this.loginComponent)
        }
        document.addEventListener("mouseup", function (e) {
            if (!this.isMouseDrag)
                this.setFocus()
            this.isMouseDrag = false
            this.ismouseDown = false
        }.bind(this))
        this.el.addEventListener("mousemove", function (e) {
            if (this.ismouseDown) {
                this.isMouseDrag = true
            }
        }.bind(this))
        this.el.addEventListener("mousedown", function (e) {
            this.ismouseDown = true
        }.bind(this))
        document.addEventListener("keypress", function (e) {
            this.ismouseDown = false
            this.isMouseDrag = false
            this.setFocus()
        }.bind(this))

    }
    keyDownHandler(e) {
        if (event.ctrlKey && event.key === 'l' || event.key === 'L') {
            this.clearScreen()
        }
    }
    clearScreen() {
        this.historyList = []
        this.history.update(this.historyList)
    }
    setFocus() {
        if (!model.state.loggedin) {
            this.loginComponent.setFocus()
        } else {
            this.commandComponent.setFocus()
        }
    }
    authenticated() {
        model.state.loggedin = true
        setChildren(this.el, [this.intro, this.history, this.commandComponent])
    }
    addCommandOutputHistory(data) {
        this.historyList.push(data)
        this.history.update(this.historyList)
    }
    setupAuth() {
        model.state.authkey = null
        this.loginComponent = new LoginComponent(this.authenticated.bind(this))
        setChildren(this.el, [this.intro, this.loginComponent])
    }
}

async function authenticate(username, password) {
    let hashBuffer = await crypto.subtle.digest("SHA-256", encoder.encode(`${username}:${password}`))
    const hashArray = Array.from(new Uint8Array(hashBuffer))
    const hashHex = hashArray
        .map((b) => b.toString(16).padStart(2, "0"))
        .join("");
    let res = await fetch(window.location.origin + "/internal/sqlite/validateLogin", {
        headers: {
            "Authorization": `Bearer ${hashHex} `
        },
        method: "GET",
    })
    if (res.ok) {
        model.state.authkey = hashHex
    }
    return res.status == 200
}

async function executeRequest(statement) {
    let resp = await fetch(window.location.origin + "/internal/sqlite/execute",
        {
            headers: {
                "Authorization": `Bearer ${model.state.authkey} `
            },
            method: "POST",
            body: JSON.stringify({ statement: statement })
        })
    if (resp.status == 401) {
        return {
            status: "failed",
            reason: "unauthorized"
        }
    }
    let data = await resp.json()
    if (data.status == "success") {
        return {
            status: "success",
            data: data.data
        }
    } else {
        const errorMessagePattern = /Error::Io\("(.*)"\)/
        const match = data.reason.match(errorMessagePattern);
        let reason = match[1] ? match[1] : data
        return {
            status: "failed",
            reason: reason
        }
    }
}

async function dumpDB() {
    let resp = await fetch(window.location.origin + "/internal/sqlite/dump",
        {
            headers: {
                "Authorization": `Bearer ${model.state.authkey} `
            },
            method: "POST",
        })

    if (resp.status == 401) {
        return {
            status: "failed",
            reason: "unauthorized"
        }
    }
    let data = await resp.json()
    if (data.status == "success") {
        return {
            status: "success",
            data: data.data
        }
    } else {
        const errorMessagePattern = /Error::Io\("(.*)"\)/
        const match = data.reason.match(errorMessagePattern);
        let reason = match[1] ? match[1] : data
        return {
            status: "failed",
            reason: reason
        }
    }
}

async function init() {
    // authKey = await getAuthKey()
    let app = new App()
    mount(document.getElementById("app"), app)
    app.setFocus()
}

document.addEventListener('DOMContentLoaded', function () {
    init()
});

function downloadTextFile(text, filename) {
    // Create a Blob object with the text content and specify the MIME type
    const blob = new Blob([text], { type: 'text/plain' });

    // Create a temporary anchor element to trigger the download
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;

    // Trigger a click event on the anchor element to start the download
    a.click();

    // Clean up by revoking the object URL to free up resources
    URL.revokeObjectURL(a.href);
}

function jsonToHtmlTable(data, headings) {
    var html = '<table>';
    console.log(data, headings)
    // Create table header
    html += '<thead><tr>';
    headings.forEach(function (heading) {
        html += '<th>' + heading + '</th>';
    });
    html += '</tr></thead>';

    // Create table body
    html += '<tbody>';
    data.forEach(function (item) {
        html += '<tr>';
        headings.forEach(function (heading) {
            html += '<td>' + (item[heading] || '') + '</td>'; // Use an empty string if the field is missing
        });
        html += '</tr>';
    });
    html += '</tbody>';

    html += '</table>';
    return html;
}</script>
  </body>
</html>
